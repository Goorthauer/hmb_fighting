<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Battle Game: Hearthstone meets HoMM3</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body>
<!-- Основной игровой интерфейс -->
<div id="mainContainer">
  <div class="top-section">
    <div id="wrestleCards">
      <div id="abilityCards"></div>
    </div>
    <div id="gameContainer">
      <canvas id="gameCanvas" width="1000" height="500"></canvas>
    </div>
    <div id="rightPanel">
      <div id="phaseContainer">
        <span class="phase"></span>
        <span class="progress">
          <span class="team0"></span>
          <span class="vs">vs</span>
          <span class="team1"></span>
        </span>
        <button id="endTurnBtn">End Turn</button>
      </div>
      <div id="battleLog">
        <h3>Battle Log</h3>
        <div id="logEntries"></div>
      </div>
    </div>
  </div>
  <div id="characterCards"></div>
</div>

<script type="module">
  import { setGameState } from './js/state.js';
  import { connectWebSocket, setClientID } from './js/websocket.js';
  import { updateCharacterCards, updateAbilityCards, updatePhaseAndProgress, updateBattleLog } from './js/renderUI.js';
  import { preloadImages,drawBoard } from './js/renderCanvas.js';
  import { setupEventListeners } from './js/eventHandlers.js';

  // Проверка clientID при загрузке страницы
  const storedClientID = localStorage.getItem('clientID');
  if (!storedClientID) {
    window.location.href = 'index.html';
  }

  // Установка clientID
  setClientID(storedClientID);

  // Подключение WebSocket и инициализация игры
  const room = localStorage.getItem('currentRoom') || 'room1';
  connectWebSocket(room, false, (event) => {
    const data = JSON.parse(event.data);
    console.log('Received WebSocket data:', data);

    // Обновление состояния и рендеринг после загрузки изображений
    preloadImages(data).then(() => {
      setGameState(data);
      updateCharacterCards(data);
      updateAbilityCards(data.teamID, data);
      drawBoard(data);
      updatePhaseAndProgress(data);
      updateBattleLog(data);

      // Подключение обработчиков событий
      setupEventListeners(data.teamID);
    }).catch((err) => {
      console.error('Failed to preload images:', err);
      // Можно отрисовать без изображений, если загрузка не удалась
      setGameState(data);
      drawBoard(data);
    });
  });
</script>
</body>
</html>